<link rel="stylesheet" href="/assets/demo.css">

<%= render(:partial => "shared/dropdown_object_menu", :locals => {:id => "object-dropdown-menu"}) %>

<div style="position:absolute">
  <div id="workspace">
    <div class="component window" id="object-dummy" style="visibility: hidden;">
      <div style="white-space: nowrap;"><b class="icon-refresh"></b>Loading...</div>
    </div>
  </div>
</div>

<script src="/assets/jquery.jsPlumb-1.3.15-all-min.js" type="text/javascript"></script>
<script src="/assets/demo.js" type="text/javascript"></script>
<script src="/assets/demo-list.js" type="text/javascript"></script>
<script src="/assets/demo-helper-jquery.js" type="text/javascript"></script>

<script type="text/javascript">
  graphDb = {
    references: {},
    superclasses: {}};

  function graphDbAddReference(iv, obj1, obj2) {
    if (!graphDb.references[obj1]) {
      graphDb.references[obj1] = {};
    }

    graphDb.references[obj1][iv] = obj2;
  }
  
  function drawGraphForObject(id) {
    console.log("drawGraphForObject(" + id + ")");

    // Draw references
    for (var obj1 in graphDb.references) {
      var first = "target";
      var second = "source";

      if (obj1 == id) {
        first = "source";
        second = "target";
      }

      for (var ivName in graphDb.references[obj1]) {
        var obj2 = graphDb.references[obj1][ivName];
        
        if (obj1 == id || obj2 == id) {
          var objectsDrawn = $("#object-" + obj1).length == 1 && $("#object-" + obj2).length == 1

          if (objectsDrawn) {
            var parameters = {
              overlays: ["Arrow", [ "Label", { label: ivName, location: 0.25, id: "myLabel"} ]
            ]};

            parameters[first] = "object-" + obj2;
            parameters[second] = "object-" + obj1;
            jsPlumb.connect(parameters);
          }
        }
      }
    }
  }

  function generateObjectWindow(id, left, top) {
    var objectWindow = $("#object-dummy").clone();
    objectWindow.attr("id", "object-" + id);
    objectWindow.css({"left": left, "top": top});
     
    $("#workspace").append(objectWindow);
    jsPlumb.draggable(objectWindow);
    objectWindow.css({"visibility": "visible"});
    objectWindow.addClass("window-mouse-out");

    objectWindow.mouseenter(function (event) {
      $(event.target).closest(".window").removeClass("window-mouse-out");
    });

    objectWindow.mouseleave(function (event) {
      $(event.target).closest(".window").addClass("window-mouse-out");
    });
  }

  function loadObject(id) {
    $.post("/ObjectExplorer/object.html", {"id": id}, function(response) {
      $("#object-" + id).html(response);

      $.post("/ObjectExplorer/object.json", {"id": id}, function(response) {
        // Save graph structure in graph_db
        for (var ivName in response.ivs) {
          graphDbAddReference(ivName, response.id, response.ivs[ivName]);
        }

        drawGraphForObject(id);
      });

      $(".draggable-new-object").draggable({
        create: function(event, ui) {
        },

        cursorAt: {left: 0, top: 0}, 

        start: function(event, ui) {
          $(event.target).find(".object-iv-name").hide();
          $(event.target).find(".object-drag-dummy").show();
        },

        stop: function(event, ui) {
          var position = $(event.target).offset();
          var id = $(event.target).data("id");
          
          if ($("#object-" + id).length === 0) {
            var left = position.left - $(event.target).width() / 2;
            var top = position.top - $(event.target).height() / 2 - $(".index").outerHeight();
         
            generateObjectWindow(id, left, top);
            loadObject(id);
          } 
         
          $(event.target).css({"top": 0});
          $(event.target).css({"left": 0});

          $(event.target).find(".object-iv-name").show();
          $(event.target).find(".object-drag-dummy").hide();
        }
      });

    });
  }

  $(document).ready(function() {
    $("#object-dummy").removeClass("ui-draggable");
    generateObjectWindow(<%= @id %>, 20, 20);
    loadObject(<%= @id %>);
  });
</script>
